# Admin Panel Setup - ç®¡ç†å‘˜é‰´æƒä¸ç»Ÿè®¡æ¦‚è§ˆ

## ğŸ“‹ æ‰§è¡Œä¿¡æ¯

**æ—¥æœŸ**: 2026-01-13  
**ä»»åŠ¡**: ç¬¬äº”é˜¶æ®µä»»åŠ¡ 1 - ç®¡ç†å‘˜é‰´æƒä¸ç»Ÿè®¡æ¦‚è§ˆ  
**çŠ¶æ€**: âœ… å®Œæˆå¹¶éƒ¨ç½²

---

## ğŸ¯ å®ç°åŠŸèƒ½

### 1. Admin é‰´æƒä¸­é—´ä»¶

**æ–‡ä»¶**: `backend/src/middleware/admin-auth.ts`

#### åŠŸèƒ½

éªŒè¯ JWT token ä¸­çš„ `isAdmin` å­—æ®µå¿…é¡»ä¸º `true`ï¼š

```typescript
export const adminAuthMiddleware = new Elysia({ name: 'admin-auth' })
  .derive(async ({ jwt, request, set }) => {
    // 1. éªŒè¯ token å­˜åœ¨
    // 2. éªŒè¯ token æœ‰æ•ˆ
    // 3. æ£€æŸ¥ isAdmin === true
    
    if (!isAdmin) {
      set.status = 403
      return { error: 'Forbidden', message: 'Admin privileges required' }
    }
    
    return {
      userId, userName, isAdmin: true
    }
  })
```

#### ä½¿ç”¨æ–¹å¼

åœ¨éœ€è¦ç®¡ç†å‘˜æƒé™çš„ API ä¸­è‡ªåŠ¨è°ƒç”¨ï¼š

```typescript
// æ¯ä¸ªç®¡ç†å‘˜ API éƒ½ä¼šè‡ªåŠ¨æ£€æŸ¥
app.get('/api/admin/stats', async ({ jwt }) => {
  const payload = await jwt.verify(token)
  
  // éªŒè¯ç®¡ç†å‘˜æƒé™
  if ((payload as any).isAdmin !== true) {
    return 403 Forbidden
  }
  
  // ... ä¸šåŠ¡é€»è¾‘
})
```

---

### 2. Admin ç»Ÿè®¡ API

**æ–‡ä»¶**: `backend/src/controllers/admin.controller.ts`

#### GET /api/admin/stats

**å…¨ç«™ç»Ÿè®¡æ•°æ®**ï¼š

```bash
curl -H "Authorization: Bearer <admin-token>" \
  https://test-spanel-bun.freessr.bid/api/admin/stats
```

**è¿”å›ç¤ºä¾‹**ï¼š

```json
{
  "users": {
    "total": 201,           // æ€»ç”¨æˆ·æ•°
    "newToday": 5           // ä»Šæ—¥æ–°å¢ç”¨æˆ·
  },
  "nodes": {
    "total": 8,            // æ€»èŠ‚ç‚¹æ•°
    "online": 8            // åœ¨çº¿èŠ‚ç‚¹æ•°
  },
  "traffic": {
    "totalUpload": "10737418240",     // æ€»ä¸Šä¼  (Bytes)
    "totalDownload": "53687091200",   // æ€»ä¸‹è½½ (Bytes)
    "totalTraffic": "161064273440"    // æ€»æµé‡ (Bytes)
  }
}
```

#### è®¡ç®—é€»è¾‘

1. **ç”¨æˆ·ç»Ÿè®¡**ï¼š
   - `total`: `SELECT COUNT(*) FROM user`
   - `newToday`: `SELECT COUNT(*) FROM user WHERE reg_date >= today AND reg_date < tomorrow`

2. **èŠ‚ç‚¹ç»Ÿè®¡**ï¼š
   - `total`: `SELECT COUNT(*) FROM ss_node`
   - `online`: `SELECT COUNT(*) FROM ss_node WHERE node_online = 1`

3. **æµé‡ç»Ÿè®¡**ï¼š
   - ä½¿ç”¨ `prisma.user.aggregate()` çš„ `_sum` èšåˆæ‰€æœ‰ç”¨æˆ·çš„ `u` å’Œ `d`
   - è¿”å› BigInt å­—ç¬¦ä¸²

---

### 3. ç®¡ç†ç«¯ä¸»é¡µ

**URL**: `https://test-spanel-bun.freessr.bid/admin/index.html`

#### UI ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Header - ç´«è‰²æ¸å˜èƒŒæ™¯                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ“Š ç®¡ç†å‘˜æ§åˆ¶å°    [Admin] [admin â–¼]  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Main Content                                 â”‚
â”‚                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ•°æ®çœ‹æ¿ - 4ä¸ªå·¨å¤§çš„ç»Ÿè®¡å¡ç‰‡              â”‚ â”‚
â”‚  â”‚                                          â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚ â”‚æ€»ç”¨æˆ·æ•° â”‚ â”‚æ€»èŠ‚ç‚¹æ•° â”‚ â”‚æ€»ä¸Šä¼ æµé‡â”‚    â”‚ â”‚
â”‚  â”‚ â”‚  201    â”‚ â”‚   8     â”‚ â”‚ 10.0 GB â”‚    â”‚ â”‚
â”‚  â”‚ â”‚ ğŸ¨æ¸å˜  â”‚ â”‚ ğŸ¨æ¸å˜  â”‚ â”‚ ğŸ¨æ¸å˜  â”‚    â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â”‚                                          â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚ â”‚
â”‚  â”‚ â”‚æ€»ä¸‹è½½æµé‡â”‚                              â”‚ â”‚
â”‚  â”‚ â”‚  5.0 GB â”‚                              â”‚ â”‚
â”‚  â”‚ â”‚ ğŸ¨æ¸å˜  â”‚                              â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ å¿«é€Ÿæ“ä½œ                                  â”‚ â”‚
â”‚  â”‚ [ç”¨æˆ·ç®¡ç†] [åˆ·æ–°ç»Ÿè®¡] [åˆ‡æ¢åˆ°ç”¨æˆ·ç«¯]     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç³»ç»Ÿä¿¡æ¯                                  â”‚ â”‚
â”‚  â”‚ ç‰ˆæœ¬ã€æ¡†æ¶ã€æ•°æ®åº“ã€æµé‡ç»Ÿè®¡              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç‰¹æ€§

1. **æ•°æ®çœ‹æ¿å¡ç‰‡**ï¼š
   - æ€»ç”¨æˆ·æ•°ï¼š201ï¼ˆä»Šæ—¥æ–°å¢ï¼‰
   - æ€»èŠ‚ç‚¹æ•°ï¼š8ï¼ˆåœ¨çº¿ï¼š8ï¼‰
   - æ€»ä¸Šä¼ /ä¸‹è½½æµé‡ï¼ˆè‡ªåŠ¨æ ¼å¼åŒ–ä¸º GBï¼‰
   - æ¸å˜è‰²å›¾æ ‡è®¾è®¡

2. **å¿«é€Ÿæ“ä½œ**ï¼š
   - ç”¨æˆ·ç®¡ç† - è·³è½¬åˆ°ç”¨æˆ·åˆ—è¡¨
   - åˆ·æ–°ç»Ÿè®¡ - é‡æ–°è·å–æœ€æ–°æ•°æ®
   - åˆ‡æ¢åˆ°ç”¨æˆ·ç«¯ - æŸ¥çœ‹æ™®é€šç”¨æˆ·è§†è§’

3. **ç³»ç»Ÿä¿¡æ¯**ï¼š
   - ç³»ç»Ÿç‰ˆæœ¬
   - åç«¯/å‰ç«¯æ¡†æ¶
   - æ•°æ®åº“çŠ¶æ€
   - æ€»æµé‡ä½¿ç”¨

#### API è°ƒç”¨

```typescript
import { api, handleApiResponse } from '@/shared/api/eden-client'

// è·å–ç»Ÿè®¡æ•°æ®
const response = await handleApiResponse(api.api.admin.stats.get())

stats.value = response
// response.users.total: 201
// response.nodes.online: 8
// response.traffic.totalTraffic: "161064273440"
```

---

## ğŸ” å®‰å…¨æœºåˆ¶

### å‰ç«¯è·¯ç”±å®ˆå«

**æ–‡ä»¶**: `frontend/src/shared/utils/router-guard.ts`

```typescript
export function checkAuth(): boolean {
  // 1. æ£€æŸ¥æ˜¯å¦ç™»å½•
  if (!auth.isLoggedIn()) {
    window.location.href = '/admin/login.html'
    return false
  }
  
  // 2. å¯¹äº /admin/* é¡µé¢ï¼Œæ£€æŸ¥ç®¡ç†å‘˜æƒé™
  if (isAdminPage()) {
    if (!auth.isAdmin()) {
      alert('éœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½è®¿é—®æ­¤é¡µé¢')
      window.location.href = '/index.html'
      return false
    }
  }
  
  return true
}
```

### åç«¯ API é‰´æƒ

æ¯ä¸ª Admin API éƒ½ä¼šæ£€æŸ¥ï¼š

1. **Token å­˜åœ¨æ€§**ï¼š`Authorization: Bearer <token>`
2. **Token æœ‰æ•ˆæ€§**ï¼šJWT ç­¾åéªŒè¯
3. **ç®¡ç†å‘˜æƒé™**ï¼š`payload.isAdmin === true`

#### ç¤ºä¾‹

```typescript
// âŒ æ™®é€šç”¨æˆ·è®¿é—®
GET /api/admin/stats
Authorization: Bearer <user_token>
â†’ 403 Forbidden "Admin privileges required"

// âœ… ç®¡ç†å‘˜è®¿é—®
GET /api/admin/stats
Authorization: Bearer <admin_token>
â†’ 200 OK { users: {...}, nodes: {...}, traffic: {...} }
```

---

## ğŸ“Š æ•°æ®æµ

### ç®¡ç†ç«¯æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¿é—®ç®¡ç†ç«¯   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ checkAuth()  â”‚ â† æ£€æŸ¥ç™»å½•çŠ¶æ€
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ âœ“
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ isAdmin()?   â”‚ â† æ£€æŸ¥ç®¡ç†å‘˜æƒé™
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ âœ“
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ api.api.admin.stats.get()â”‚ â† Eden Client è‡ªåŠ¨æ³¨å…¥ token
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç«¯éªŒè¯:                 â”‚
â”‚ 1. JWT éªŒè¯               â”‚
â”‚ 2. isAdmin æ£€æŸ¥           â”‚
â”‚ 3. æŸ¥è¯¢æ•°æ®åº“ç»Ÿè®¡          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿”å›ç»Ÿè®¡æ•°æ®              â”‚
â”‚ { users, nodes, traffic } â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¡µé¢æ¸²æŸ“                  â”‚
â”‚ 4 ä¸ªå·¨å¤§çš„ç»Ÿè®¡å¡ç‰‡        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ è®¿é—®åœ°å€

### ç®¡ç†ç«¯æ§åˆ¶å°

```
https://test-spanel-bun.freessr.bid/admin/index.html
```

### æµ‹è¯•è´¦å·

```
Email: test-spanel@ssmail.win
Password: testSpanelRsync@*
User ID: 1
isAdmin: true âœ“
```

---

## ğŸ’¡ æŠ€æœ¯äº®ç‚¹

1. **ç‰©ç†éš”ç¦»**ï¼šAdmin API è·¯å¾„ä¸º `/api/admin/*`ï¼Œä¸ç”¨æˆ·ç«¯å®Œå…¨åˆ†ç¦»
2. **åŒé‡æ£€æŸ¥**ï¼šå‰ç«¯è·¯ç”±å®ˆå« + åç«¯ API é‰´æƒ
3. **è‡ªåŠ¨æ³¨å…¥**ï¼šEden Client è‡ªåŠ¨æ·»åŠ  Authorization å¤´
4. **ç±»å‹å®‰å…¨**ï¼šEden Treaty å®Œæ•´ç±»å‹æ¨å¯¼
5. **æ¸å˜è®¾è®¡**ï¼šç®¡ç†ç«¯ä½¿ç”¨ç´«è‰²æ¸å˜ï¼Œè§†è§‰ä¸Šä¸ç”¨æˆ·ç«¯åŒºåˆ†

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### åç«¯

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `backend/src/middleware/admin-auth.ts` | Admin é‰´æƒä¸­é—´ä»¶ |
| `backend/src/controllers/admin.controller.ts` | Admin API æ§åˆ¶å™¨ |
| `backend/src/index.ts` | ä¸»åº”ç”¨ï¼ˆå·²é›†æˆ admin controllerï¼‰ |

### å‰ç«¯

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `frontend/src/shared/utils/router-guard.ts` | è·¯ç”±å®ˆå«ï¼ˆå·²æ·»åŠ  admin æ£€æŸ¥ï¼‰ |
| `frontend/src/pages/admin/Dashboard.vue` | ç®¡ç†ç«¯ä¸»é¡µç»„ä»¶ |
| `frontend/src/pages/admin/index-main.ts` | ç®¡ç†ç«¯å…¥å£ |
| `frontend/public/admin/index.html` | ç®¡ç†ç«¯ HTML |

---

## âœ… å®Œæˆæ¸…å•

- [x] Admin é‰´æƒä¸­é—´ä»¶
- [x] Admin ç»Ÿè®¡ API (`/api/admin/stats`)
- [x] ç®¡ç†ç«¯è·¯ç”±å®ˆå«ï¼ˆæ£€æŸ¥ isAdminï¼‰
- [x] ç®¡ç†ç«¯ä¸»é¡µï¼ˆ4 ä¸ªç»Ÿè®¡å¡ç‰‡ï¼‰
- [x] å‰ç«¯æ„å»ºéƒ¨ç½²
- [x] ç±»å‹å®‰å…¨ API è°ƒç”¨

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**ç”Ÿæˆæ—¶é—´**: 2026-01-13  
**ä½œè€…**: Claude (AI Assistant)
