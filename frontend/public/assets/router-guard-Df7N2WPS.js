var re=Object.defineProperty,ne=Object.defineProperties;var se=Object.getOwnPropertyDescriptors;var N=Object.getOwnPropertySymbols;var C=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable;var _=(e,t,r)=>t in e?re(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,c=(e,t)=>{for(var r in t||(t={}))C.call(t,r)&&_(e,r,t[r]);if(N)for(var r of N(t))J.call(t,r)&&_(e,r,t[r]);return e},x=(e,t)=>ne(e,se(t));var Y=(e,t)=>{var r={};for(var n in e)C.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(e!=null&&N)for(var n of N(e))t.indexOf(n)<0&&J.call(e,n)&&(r[n]=e[n]);return r};var T=(e,t,r)=>_(e,typeof t!="symbol"?t+"":t,r);var v=(e,t,r)=>new Promise((n,s)=>{var o=h=>{try{i(r.next(h))}catch(g){s(g)}},l=h=>{try{i(r.throw(h))}catch(g){s(g)}},i=h=>h.done?n(h.value):Promise.resolve(h.value).then(o,l);i((r=r.apply(e,t)).next())});var oe=class extends Error{constructor(e,t){super(t+""),this.status=e,this.value=t}},ie=/(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))/,ae=/(?:Sun|Mon|Tue|Wed|Thu|Fri|Sat)\s(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s\d{2}\s\d{4}\s\d{2}:\d{2}:\d{2}\sGMT(?:\+|-)\d{4}\s\([^)]+\)/,le=/^(?:(?:(?:(?:0?[1-9]|[12][0-9]|3[01])[/\s-](?:0?[1-9]|1[0-2])[/\s-](?:19|20)\d{2})|(?:(?:19|20)\d{2}[/\s-](?:0?[1-9]|1[0-2])[/\s-](?:0?[1-9]|[12][0-9]|3[01]))))(?:\s(?:1[012]|0?[1-9]):[0-5][0-9](?::[0-5][0-9])?(?:\s[AP]M)?)?$/,ce=e=>e.trim().length!==0&&!Number.isNaN(Number(e)),q=e=>{if(typeof e!="string")return null;let t=e.replace(/"/g,"");if(ie.test(t)||ae.test(t)||le.test(t)){let r=new Date(t);if(!Number.isNaN(r.getTime()))return r}return null},ue=e=>{let t=e.charCodeAt(0),r=e.charCodeAt(e.length-1);return t===123&&r===125||t===91&&r===93},de=e=>JSON.parse(e,(t,r)=>q(r)||r),G=e=>{if(!e)return e;if(ce(e))return+e;if(e==="true")return!0;if(e==="false")return!1;let t=q(e);if(t)return t;if(ue(e))try{return de(e)}catch(r){}return e},fe=e=>{let t=e.data.toString();return t==="null"?null:G(t)},he=(e,t,r)=>{if(e.endsWith("/")||(e+="/"),t==="index"&&(t=""),!r||!Object.keys(r).length)return`${e}${t}`;let n="";for(let[s,o]of Object.entries(r))n+=`${s}=${o}&`;return`${e}${t}?${n.slice(0,-1)}`},O=typeof FileList>"u",z=e=>O?e instanceof Blob:e instanceof FileList||e instanceof File,ge=e=>{if(!e)return!1;for(let t in e)if(z(e[t])||Array.isArray(e[t])&&e[t].find(r=>z(r)))return!0;return!1},U=e=>O?e:new Promise(t=>{let r=new FileReader;r.onload=()=>{let n=new File([r.result],e.name,{lastModified:e.lastModified,type:e.type});t(n)},r.readAsArrayBuffer(e)}),pe=class{constructor(e){T(this,"ws");T(this,"url");this.ws=new WebSocket(e),this.url=e}send(e){return Array.isArray(e)?(e.forEach(t=>this.send(t)),this):(this.ws.send(typeof e=="object"?JSON.stringify(e):e.toString()),this)}on(e,t,r){return this.addEventListener(e,t,r)}off(e,t,r){return this.ws.removeEventListener(e,t,r),this}subscribe(e,t){return this.addEventListener("message",e,t)}addEventListener(e,t,r){return this.ws.addEventListener(e,n=>{if(e==="message"){let s=fe(n);t(x(c({},n),{data:s}))}else t(n)},r),this}removeEventListener(e,t,r){return this.off(e,t,r),this}close(){return this.ws.close(),this}},H=(e,t="",r)=>new Proxy(()=>{},{get(n,s,o){return H(e,`${t}/${s.toString()}`,r)},apply(n,s,[o,l={}]=[{},{}]){var M,R;let i=o!==void 0&&(typeof o!="object"||Array.isArray(o))?o:void 0,j=o!=null?o:{},{$query:h,$fetch:g,$headers:Z,$transform:E,getRaw:V}=j,Q=Y(j,["$query","$fetch","$headers","$transform","getRaw"]);i!=null||(i=Q);let I=t.lastIndexOf("/"),k=t.slice(I+1).toUpperCase(),$=he(e,I===-1?"/":t.slice(0,I),Object.assign((M=l.query)!=null?M:{},h)),X=(R=r.fetcher)!=null?R:fetch,w=r.transform?Array.isArray(r.transform)?r.transform:[r.transform]:void 0,b=E?Array.isArray(E)?E:[E]:void 0;return b&&(w?w=b.concat(w):w=b),k==="SUBSCRIBE"?new pe($.replace(/^([^]+):\/\//,$.startsWith("https://")?"wss://":"ws://")):(ee=>v(this,null,function*(){var L,K;let u,D=c(c(c(c({},(L=r.$fetch)==null?void 0:L.headers),g==null?void 0:g.headers),l.headers),Z);if(k!=="GET"&&k!=="HEAD"){u=Object.keys(i).length||Array.isArray(i)?i:void 0;let y=u&&(typeof u=="object"||Array.isArray(i));if(y&&ge(u)){let a=new FormData;for(let[A,f]of Object.entries(u))if(O)a.append(A,f);else if(f instanceof File)a.append(A,yield U(f));else if(f instanceof FileList)for(let p=0;p<f.length;p++)a.append(A,yield U(f[p]));else if(Array.isArray(f))for(let p=0;p<f.length;p++){let P=f[p];a.append(A,P instanceof File?yield U(P):P)}else a.append(A,f);u=a}else u!=null&&(D["content-type"]=y?"application/json":"text/plain",u=y?JSON.stringify(u):i)}let d=yield X($,x(c(c(c({method:k,body:u},r.$fetch),l.fetch),g),{headers:D})),S;if(ee.getRaw)return d;switch((K=d.headers.get("Content-Type"))==null?void 0:K.split(";")[0]){case"application/json":S=yield d.json();break;default:S=yield d.text().then(G)}let te=d.status>=300||d.status<200?new oe(d.status,S):null,F={data:S,error:te,response:d,status:d.status,headers:d.headers};if(w)for(let y of w){let a=y(F);a instanceof Promise&&(a=yield a),a!=null&&(F=a)}return F}))({getRaw:V})}}),me=(e,t={fetcher:fetch})=>new Proxy({},{get(r,n){return H(e,n,t)}});class B{static setToken(t){try{localStorage.setItem(this.TOKEN_KEY,t)}catch(r){console.error("Failed to store token:",r)}}static getToken(){try{return localStorage.getItem(this.TOKEN_KEY)}catch(t){return console.error("Failed to retrieve token:",t),null}}static isLoggedIn(){const t=this.getToken();return t!==null&&t!==""}static setUserInfo(t){try{localStorage.setItem(this.USER_KEY,JSON.stringify(t))}catch(r){console.error("Failed to store user info:",r)}}static getUserInfo(){try{const t=localStorage.getItem(this.USER_KEY);return t?JSON.parse(t):null}catch(t){return console.error("Failed to retrieve user info:",t),null}}static logout(){try{localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.USER_KEY),typeof window!="undefined"&&(window.location.href="/user/login.html")}catch(t){console.error("Failed to logout:",t)}}static getAuthHeader(){const t=this.getToken();return t?{Authorization:`Bearer ${t}`}:{}}static parseToken(t){try{const r=t||this.getToken();if(!r)return null;const n=r.split(".");if(n.length!==3)return null;const s=n[1],o=atob(s.replace(/-/g,"+").replace(/_/g,"/"));return JSON.parse(o)}catch(r){return console.error("Failed to parse token:",r),null}}static isTokenExpired(){const t=this.parseToken();if(!t||!t.exp)return!1;const r=t.exp*1e3;return Date.now()>=r}static getUserId(){const t=this.parseToken();return(t==null?void 0:t.userId)||null}static getUserName(){const t=this.parseToken();return(t==null?void 0:t.user_name)||null}static isAdmin(){const t=this.parseToken();return(t==null?void 0:t.isAdmin)===!0}}T(B,"TOKEN_KEY","spanel_jwt_token"),T(B,"USER_KEY","spanel_user_info");const m=B,we="https://test-spanel-bun.freessr.bid",Se=me(we,{fetcher:{fetch:(r,...n)=>v(void 0,[r,...n],function*(e,t={}){const s=m.getToken(),o=c({"Content-Type":"application/json"},t.headers);return s&&(o.Authorization=`Bearer ${s}`),fetch(e,x(c({},t),{headers:o}))})}});function ye(e){return!!e.error}function Ne(e){return v(this,null,function*(){var r,n,s,o,l;const t=yield e;if(ye(t))throw(n=(r=t.error)==null?void 0:r.message)!=null&&n.includes("Unauthorized")||(o=(s=t.error)==null?void 0:s.message)!=null&&o.includes("Invalid or expired token")?(m.logout(),new Error("Authentication failed. Please login again.")):new Error(((l=t.error)==null?void 0:l.message)||"API request failed");if(!t.data)throw new Error("No data returned from API");return t.data})}function xe(e,t=2){const r=typeof e=="string"?parseInt(e,10):e;if(r===0)return"0 B";const n=1024,s=t<0?0:t,o=["B","KB","MB","GB","TB","PB"],l=Math.floor(Math.log(r)/Math.log(n));return parseFloat((r/Math.pow(n,l)).toFixed(s))+" "+o[l]}function ve(e){return e.toFixed(2)+"%"}function Ie(e){const t=typeof e=="string"?new Date(e):e;return isNaN(t.getTime())?"N/A":t.toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}function $e(e){return"¥"+(typeof e=="string"?parseFloat(e):e).toFixed(2)}function be(e){return{1:"Shadowsocks",2:"ShadowsocksR",11:"V2Ray",7:"V2Ray (旧版)"}[e]||`Unknown (${e})`}function Fe(e){return e>=90?"#f56c6c":e>=70?"#e6a23c":e>=50?"#409eff":"#67c23a"}function Pe(e){if(!e)return null;const t=new Date(e),r=new Date;if(isNaN(t.getTime()))return null;const n=t.getTime()-r.getTime(),s=Math.ceil(n/(1e3*60*60*24));return s>0?s:0}const Ae=["/login.html","/register.html","/user/login.html","/user/register.html"],Te=["/admin/","/admin/index.html","/admin/dashboard.html","/admin/users.html"];function Ee(){const e=window.location.pathname;return Ae.some(t=>e===t||e.startsWith(t))}function W(){const e=window.location.pathname;return Te.some(t=>e.startsWith(t))}function _e(){if(Ee())return!0;if(!m.isLoggedIn()){const e=window.location.href,t=W()?"/admin/login.html":"/user/login.html";return console.warn("User not authenticated, redirecting to login..."),e&&!e.includes("login.html")&&sessionStorage.setItem("redirect_after_login",e),window.location.href=t,!1}return m.isTokenExpired()?(console.warn("Token expired, logging out..."),m.logout(),!1):W()&&!m.isAdmin()?(console.warn("Access denied: Admin privileges required"),alert("需要管理员权限才能访问此页面"),window.location.href="/index.html",!1):!0}function Ue(){setInterval(()=>{const e=m.parseToken();if(!e||!e.exp)return;const r=e.exp*1e3-Date.now();if(r>0&&r<5*60*1e3){const n=Math.ceil(r/6e4);console.warn(`Token will expire in ${n} minute(s)`)}},60*1e3)}export{Fe as a,m as b,Ie as c,ve as d,xe as e,$e as f,Pe as g,Ne as h,Se as i,_e as j,be as k,Ue as s};
